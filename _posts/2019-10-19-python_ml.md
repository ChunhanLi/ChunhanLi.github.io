---
layout:     post
title:      Python_ML
subtitle:   常用代码存储
date:       2019-10-19
author:     Midone
header-img: img/post-bg-re-vs-ng2.jpg
catalog: True
tags:
    - 编程语言
---


### 前言

这个章节会记录一些机器学习比赛中常用的一些套路模板


#### count encoding
```python
for i in count_columns:
    train[i+'_count_full'] = train[i].map(pd.concat([train[i], test[i]], ignore_index=True).value_counts(dropna=False))
    test[i+'_count_full'] = test[i].map(pd.concat([train[i], test[i]], ignore_index=True).value_counts(dropna=False))
```

#### rolling function
```python
## https://blog.csdn.net/maymay_/article/details/80241627
```

#### define eval_function in sklearn
```python
# https://github.com/microsoft/LightGBM/blob/master/examples/python-guide/sklearn_example.py
# self-defined eval metric
# f(y_true: array, y_pred: array) -> name: string, eval_result: float, is_higher_better: bool
# Root Mean Squared Logarithmic Error (RMSLE)
def rmsle(y_true, y_pred):
    return 'RMSLE', np.sqrt(np.mean(np.power(np.log1p(y_pred) - np.log1p(y_true), 2))), False
def rae(y_true, y_pred):
    return 'RAE', np.sum(np.abs(y_pred - y_true)) / np.sum(np.abs(np.mean(y_true) - y_true)), False

#### 分类问题 y_prob.reshape((len(y_true),-1),order='F') 
### 需要这个操作 返回的y_prob是概率 不是预测值
def CRPS_eval(y_true, y_prob):
    y_prob =  y_prob.reshape((len(y_true),-1),order='F')
    global a
    a=y_prob.copy()
    
    y_pred_array1 = raw_y_to_array2(y_prob,num_counts,bins)
    if len(y_true) < y_train.shape[0]/3:
        index1 = test_index.copy()
    else:
        index1 = train_index.copy()
    return 'CRPS', cal_CPRS(y_true_array1[index1,:],y_pred_array1), False
```

#### 将列值转换成列名
```python
example = pd.DataFrame({'Team':['team1','team2']*3,'score':[1,2,3,4,5,6],'times':[6,5,3,2,1,1],'id':[1,1,1,1,1,1]
                        ,'player':['player1','player1','player2','player2','player3','player3']})
example
temp1 = pd.pivot_table(example,columns=['Team','player'],aggfunc=lambda x:x,index=['id'])
temp1
temp1.columns = ['_'.join(a) for a in temp1.columns.values]
temp1
```

#### 画图
```python
ax = sns.distplot(train.loc[train.Season==2017,'Orientation'].fillna(0),label = '2017')
ax = sns.distplot(train.loc[train.Season==2018,'Orientation'].fillna(0),label = '2018')
ax = sns.distplot(test.loc[test.Season==2019,'Orientation'].fillna(0),label = '2019')
plt.legend(prop={'size': 12})
```

#### lgb调参
```python
lgb.LGBMClassifier(n_estimators=10000, random_state=seed2,subsample=subsample1,
                         colsample_bytree=colsample_bytree1,learning_rate=0.01,importance_type = 'gain',
                 max_depth = -1, num_leaves = int(num_leaves1),min_child_samples=int(min_child_samples1),
                                 min_child_weight = min_child_weight1,min_split_gain = min_split_gain1,
                   bagging_freq=1,reg_alpha = reg_alpha1,reg_lambda = reg_lambda1,n_jobs = -1,metric='None',
                                scale_pos_weight = scale_pos_weight1)
### num_leaves default:31
[32,64,128,256]
###colsample_bytree、subsample
[0.5,0.6,0.7,0.8,0.9，1]
### min_child_weight 1e-3
[0.0001,0.01,0.1]
### min_child_samples 20
[5,10,40,80]
### min_split_gain 0
[0,0.01,0.1,1]
### reg_alpha 0
### reg_lambda 0
### scale_pos_weight

```